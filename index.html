
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyNotes - Note Taking App</title>
    <style>
        /* CSS completo incorporato */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f5f5f5; 
            height: 100vh; 
            overflow: hidden; 
        }
        
        .app-container { 
            display: flex; 
            height: 100vh; 
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 300px;
            background-color: #2c3e50;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #34495e;
        }
        
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #34495e;
        }
        
        .sidebar-header h2 {
            margin-bottom: 15px;
            font-size: 24px;
            color: white;
        }
        
        .sidebar-header h2 i {
            margin-right: 8px;
        }
        
        .add-note-btn {
            width: 100%;
            padding: 12px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
            margin-bottom: 10px;
        }
        
        .add-note-btn:hover {
            background-color: #2980b9;
        }
        
        .backup-controls {
            margin-top: 15px;
            display: flex;
            gap: 8px;
        }
        
        .backup-btn {
            flex: 1;
            padding: 10px 8px;
            background-color: #27ae60;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }
        
        .backup-btn:hover {
            background-color: #229954;
        }
        
        .backup-btn:nth-child(2) {
            background-color: #f39c12;
        }
        
        .backup-btn:nth-child(2):hover {
            background-color: #e67e22;
        }
        
        .color-picker-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #34495e;
            border-radius: 5px;
            border: 1px solid #2c3e50;
        }
        
        .color-picker-container h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #ecf0f1;
        }
        
        .color-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
        
        .color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #2c3e50;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .color-btn:hover {
            transform: scale(1.1);
            border-color: #ecf0f1;
        }
        
        .notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .note-item {
            padding: 15px;
            margin-bottom: 5px;
            background-color: #34495e;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            border-left: 4px solid transparent;
        }
        
        .note-item:hover {
            transform: translateX(2px);
        }
        
        .note-item.active {
            background-color: #2c3e50;
            border-left-color: #ecf0f1;
        }
        
        .note-item.has-color {
            border-left-width: 6px;
        }
        
        .note-item h4 {
            font-size: 16px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .note-item p {
            font-size: 12px;
            color: #bdc3c7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .note-item .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .note-item .expand-btn {
            position: absolute;
            top: 10px;
            right: 35px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .note-item .color-change-btn {
            position: absolute;
            top: 10px;
            right: 60px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 3px;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .note-item:hover .delete-btn,
        .note-item:hover .expand-btn,
        .note-item:hover .color-change-btn {
            opacity: 1;
        }
        
        /* Sub-sidebar Styles */
        .sub-sidebar {
            width: 0;
            background-color: #34495e;
            color: white;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #2c3e50;
            transition: width 0.3s ease;
            overflow: hidden;
        }
        
        .sub-sidebar.open {
            width: 280px;
        }
        
        .sub-sidebar-header {
            padding: 15px;
            border-bottom: 1px solid #2c3e50;
            position: relative;
        }
        
        .sub-sidebar-header h3 {
            margin: 10px 0;
            font-size: 18px;
            padding-right: 30px;
            color: white;
        }
        
        .sub-color-picker-container {
            margin: 15px 0;
            padding: 15px;
            background-color: #2c3e50;
            border-radius: 5px;
            border: 1px solid #34495e;
        }
        
        .sub-color-picker-container h4 {
            margin-bottom: 10px;
            font-size: 14px;
            color: #ecf0f1;
        }
        
        .sub-color-btn {
            width: 30px;
            height: 30px;
            border: 2px solid #34495e;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
            width: 25px;
            height: 25px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            background-color: #e74c3c;
        }
        
        .sub-notes-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .sub-note-item {
            padding: 12px;
            margin-bottom: 5px;
            background-color: #2c3e50;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
            position: relative;
            border-left: 3px solid #3498db;
        }
        
        .sub-note-item.has-color {
            border-left-width: 5px;
        }
        
        .sub-note-item:hover {
            background-color: #2f4456;
        }
        
        .sub-note-item.active {
            background-color: #3498db;
            border-left-color: #2980b9;
        }
        
        .sub-note-item h5 {
            font-size: 14px;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            color: white;
        }
        
        .sub-note-item p {
            font-size: 11px;
            color: #bdc3c7;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .sub-note-item .delete-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 9px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sub-note-item .sub-color-change-btn {
            position: absolute;
            top: 8px;
            right: 30px;
            background: #9b59b6;
            color: white;
            border: none;
            border-radius: 3px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            font-size: 9px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sub-note-item:hover .delete-btn,
        .sub-note-item:hover .sub-color-change-btn {
            opacity: 1;
        }
        
        /* Main Content Styles */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background-color: white;
        }
        
        .editor-header {
            padding: 20px;
            border-bottom: 1px solid #ecf0f1;
            background-color: #fafafa;
        }
        
        .note-title-input {
            width: 100%;
            font-size: 24px;
            font-weight: bold;
            border: none;
            outline: none;
            background: transparent;
            margin-bottom: 15px;
            padding: 5px 0;
            color: #2c3e50;
        }
        
        .toolbar {
            display: flex;
            gap: 5px;
        }
        
        .toolbar button {
            padding: 8px 12px;
            border: 1px solid #bdc3c7;
            background-color: white;
            cursor: pointer;
            border-radius: 3px;
            transition: background-color 0.3s;
            color: #2c3e50;
        }
        
        .toolbar button:hover {
            background-color: #ecf0f1;
        }
        
        .toolbar button.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }
        
        .editor-container {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .editor {
            min-height: 100%;
            outline: none;
            font-size: 16px;
            line-height: 1.6;
            color: #2c3e50;
        }
        
        .editor:empty::before {
            content: attr(placeholder);
            color: #95a5a6;
            font-style: italic;
        }
        
        .status-bar {
            padding: 10px 20px;
            background-color: #ecf0f1;
            border-top: 1px solid #bdc3c7;
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #7f8c8d;
        }
        
        .editor table {
            border-collapse: collapse;
            width: 100%;
            margin: 10px 0;
        }
        
        .editor th,
        .editor td {
            border: 1px solid #bdc3c7;
            padding: 8px;
            text-align: left;
        }
        
        .editor th {
            background-color: #ecf0f1;
            font-weight: bold;
        }
        
        .editor ul,
        .editor ol {
            margin: 10px 0;
            padding-left: 20px;
        }
        
        .editor li {
            margin: 5px 0;
        }
    </style>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-sticky-note"></i> MyNotes</h2>
                <div class="color-picker-container" id="color-picker-container" style="display: none;">
                    <h4>Scegli colore nota:</h4>
                    <div class="color-options">
                        <button class="color-btn" data-color="#3498db" style="background-color: #3498db;" title="Blu"></button>
                        <button class="color-btn" data-color="#e74c3c" style="background-color: #e74c3c;" title="Rosso"></button>
                        <button class="color-btn" data-color="#2ecc71" style="background-color: #2ecc71;" title="Verde"></button>
                        <button class="color-btn" data-color="#f39c12" style="background-color: #f39c12;" title="Arancione"></button>
                        <button class="color-btn" data-color="#9b59b6" style="background-color: #9b59b6;" title="Viola"></button>
                        <button class="color-btn" data-color="#1abc9c" style="background-color: #1abc9c;" title="Turchese"></button>
                        <button class="color-btn" data-color="#e67e22" style="background-color: #e67e22;" title="Arancione scuro"></button>
                        <button class="color-btn" data-color="#34495e" style="background-color: #34495e;" title="Grigio scuro"></button>
                    </div>
                </div>
                <button id="add-note-btn" class="add-note-btn">
                    <i class="fas fa-plus"></i> Nuova Nota
                </button>
                <div class="backup-controls">
                    <button id="export-backup-btn" class="backup-btn">
                        <i class="fas fa-download"></i> Esporta Backup
                    </button>
                    <button id="import-backup-btn" class="backup-btn">
                        <i class="fas fa-upload"></i> Importa Backup
                    </button>
                    <input type="file" id="backup-file-input" accept=".json" style="display: none;">
                </div>
            </div>
            <div class="notes-list" id="notes-list">
                <!-- Notes will be dynamically added here -->
            </div>
        </div>

        <!-- Sub-notes Sidebar -->
        <div class="sub-sidebar" id="sub-sidebar">
            <div class="sub-sidebar-header">
                <button id="close-sub-sidebar" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
                <h3 id="parent-note-title">Sotto-note</h3>
                <div class="sub-color-picker-container" id="sub-color-picker-container" style="display: none;">
                    <h4>Scegli colore sotto-nota:</h4>
                    <div class="color-options">
                        <button class="sub-color-btn" data-color="#3498db" style="background-color: #3498db;" title="Blu"></button>
                        <button class="sub-color-btn" data-color="#e74c3c" style="background-color: #e74c3c;" title="Rosso"></button>
                        <button class="sub-color-btn" data-color="#2ecc71" style="background-color: #2ecc71;" title="Verde"></button>
                        <button class="sub-color-btn" data-color="#f39c12" style="background-color: #f39c12;" title="Arancione"></button>
                        <button class="sub-color-btn" data-color="#9b59b6" style="background-color: #9b59b6;" title="Viola"></button>
                        <button class="sub-color-btn" data-color="#1abc9c" style="background-color: #1abc9c;" title="Turchese"></button>
                        <button class="sub-color-btn" data-color="#e67e22" style="background-color: #e67e22;" title="Arancione scuro"></button>
                        <button class="sub-color-btn" data-color="#34495e" style="background-color: #34495e;" title="Grigio scuro"></button>
                    </div>
                </div>
                <button id="add-sub-note-btn" class="add-note-btn">
                    <i class="fas fa-plus"></i> Nuova Sotto-nota
                </button>
            </div>
            <div class="sub-notes-list" id="sub-notes-list">
                <!-- Sub-notes will be dynamically added here -->
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <div class="editor-header">
                <input type="text" id="note-title" placeholder="Titolo della nota..." class="note-title-input">
                <div class="toolbar">
                    <button onclick="formatText('bold')" title="Grassetto"><i class="fas fa-bold"></i></button>
                    <button onclick="formatText('italic')" title="Corsivo"><i class="fas fa-italic"></i></button>
                    <button onclick="formatText('underline')" title="Sottolineato"><i class="fas fa-underline"></i></button>
                    <button onclick="formatText('insertUnorderedList')" title="Lista"><i class="fas fa-list-ul"></i></button>
                    <button onclick="formatText('insertOrderedList')" title="Lista numerata"><i class="fas fa-list-ol"></i></button>
                    <button onclick="insertTable()" title="Tabella"><i class="fas fa-table"></i></button>
                </div>
            </div>
            <div class="editor-container">
                <div id="editor" contenteditable="true" class="editor" placeholder="Inizia a scrivere la tua nota...">
                    <p>Benvenuto in MyNotes! Inizia a scrivere qui...</p>
                </div>
            </div>
            <div class="status-bar">
                <span id="word-count">Parole: 0</span>
                <span id="last-saved">Ultima modifica: mai</span>
            </div>
        </div>
    </div>

    <script>
        class NotesApp {
            constructor() {
                this.notes = JSON.parse(localStorage.getItem('notes')) || [];
                this.currentNoteId = null;
                this.currentParentNoteId = null;
                this.autoSaveTimer = null;
                this.isSubSidebarOpen = false;
                this.selectedColor = '#3498db';
                this.selectedSubColor = '#3498db';
                
                this.init();
            }
            
            init() {
                this.bindEvents();
                this.renderNotesList();
                
                if (this.notes.length > 0) {
                    this.loadNote(this.notes[0].id);
                } else {
                    this.createNewNote();
                }
                
                // Auto-save every 2 seconds
                setInterval(() => this.autoSave(), 2000);
                
                // Update word count
                setInterval(() => this.updateWordCount(), 1000);
            }
            
            bindEvents() {
                // Add new note button
                document.getElementById('add-note-btn').addEventListener('click', () => {
                    this.toggleColorPicker();
                });
                
                // Color picker buttons
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectColor(e.target.dataset.color);
                        this.createNewNote();
                        this.hideColorPicker();
                    });
                });
                
                // Add sub-note button
                document.getElementById('add-sub-note-btn').addEventListener('click', () => {
                    this.toggleSubColorPicker();
                });
                
                // Sub-note color picker buttons
                document.querySelectorAll('.sub-color-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        this.selectSubColor(e.target.dataset.color);
                        this.createNewSubNote();
                        this.hideSubColorPicker();
                    });
                });
                
                // Close sub-sidebar button
                document.getElementById('close-sub-sidebar').addEventListener('click', () => {
                    this.closeSubSidebar();
                });
                
                // Note title input
                document.getElementById('note-title').addEventListener('input', () => {
                    this.autoSave();
                });
                
                // Editor content changes
                document.getElementById('editor').addEventListener('input', () => {
                    this.autoSave();
                });
                
                // Backup export button
                document.getElementById('export-backup-btn').addEventListener('click', () => {
                    this.exportBackup();
                });
                
                // Backup import button
                document.getElementById('import-backup-btn').addEventListener('click', () => {
                    document.getElementById('backup-file-input').click();
                });
                
                // File input for backup import
                document.getElementById('backup-file-input').addEventListener('change', (e) => {
                    this.importBackup(e.target.files[0]);
                });
                
                // Prevent default behavior for some keys
                document.getElementById('editor').addEventListener('keydown', (e) => {
                    if (e.key === 'Tab') {
                        e.preventDefault();
                        document.execCommand('insertText', false, '    ');
                    }
                });
            }
            
            createNewNote() {
                const newNote = {
                    id: Date.now().toString(),
                    title: 'Nuova Nota',
                    content: '<p>Inizia a scrivere qui...</p>',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    subNotes: [],
                    color: this.selectedColor
                };
                
                this.notes.unshift(newNote);
                this.saveNotes();
                this.renderNotesList();
                this.loadNote(newNote.id);
                this.closeSubSidebar();
            }
            
            loadNote(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;
                
                this.currentNoteId = noteId;
                this.currentParentNoteId = null;
                
                document.getElementById('note-title').value = note.title;
                document.getElementById('editor').innerHTML = note.content;
                
                // Update active note in sidebar
                document.querySelectorAll('.note-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const noteItem = document.querySelector(`[data-note-id="${noteId}"]`);
                if (noteItem) {
                    noteItem.classList.add('active');
                }
                
                this.updateLastSaved(note.updatedAt);
            }
            
            deleteNote(noteId) {
                if (this.notes.length <= 1) {
                    alert('Non puoi eliminare l\'ultima nota!');
                    return;
                }
                
                if (confirm('Sei sicuro di voler eliminare questa nota?')) {
                    this.notes = this.notes.filter(n => n.id !== noteId);
                    this.saveNotes();
                    this.renderNotesList();
                    
                    if (this.currentNoteId === noteId) {
                        this.loadNote(this.notes[0].id);
                    }
                }
            }
            
            autoSave() {
                if (!this.currentNoteId) return;
                
                const title = document.getElementById('note-title').value;
                const content = document.getElementById('editor').innerHTML;
                
                // Check if it's a sub-note
                if (this.currentParentNoteId) {
                    const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                    if (!parentNote || !parentNote.subNotes) return;
                    
                    const subNote = parentNote.subNotes.find(n => n.id === this.currentNoteId);
                    if (!subNote) return;
                    
                    if (subNote.title !== title || subNote.content !== content) {
                        subNote.title = title || 'Senza titolo';
                        subNote.content = content;
                        subNote.updatedAt = new Date().toISOString();
                        
                        this.saveNotes();
                        this.renderSubNotesList();
                        this.updateLastSaved(subNote.updatedAt);
                    }
                } else {
                    // Regular note
                    const note = this.notes.find(n => n.id === this.currentNoteId);
                    if (!note) return;
                    
                    if (note.title !== title || note.content !== content) {
                        note.title = title || 'Senza titolo';
                        note.content = content;
                        note.updatedAt = new Date().toISOString();
                        
                        this.saveNotes();
                        this.renderNotesList();
                        this.updateLastSaved(note.updatedAt);
                    }
                }
            }
            
            saveNotes() {
                localStorage.setItem('notes', JSON.stringify(this.notes));
            }
            
            renderNotesList() {
                const notesList = document.getElementById('notes-list');
                notesList.innerHTML = '';
                
                this.notes.forEach(note => {
                    const noteItem = document.createElement('div');
                    noteItem.className = 'note-item';
                    noteItem.setAttribute('data-note-id', note.id);
                    
                    const preview = this.getTextPreview(note.content);
                    const date = new Date(note.updatedAt).toLocaleDateString('it-IT');
                    
                    const hasSubNotes = note.subNotes && note.subNotes.length > 0;
                    const expandIcon = hasSubNotes ? '<i class="fas fa-chevron-right expand-icon"></i>' : '';
                    
                    // Applica il colore della nota se presente
                    if (note.color) {
                        noteItem.style.borderLeftColor = note.color;
                        noteItem.classList.add('has-color');
                    }
                    
                    noteItem.innerHTML = `
                        <h4>${note.title} ${expandIcon}</h4>
                        <p>${preview} • ${date}</p>
                        <button class="delete-btn" onclick="app.deleteNote('${note.id}')" title="Elimina nota">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="expand-btn" onclick="app.openSubSidebar('${note.id}')" title="Vedi sotto-note">
                            <i class="fas fa-folder-open"></i>
                        </button>
                        <button class="color-change-btn" onclick="app.changeNoteColor('${note.id}')" title="Cambia colore">
                            <i class="fas fa-palette"></i>
                        </button>
                    `;
                    
                    noteItem.addEventListener('click', (e) => {
                        if (!e.target.closest('.delete-btn') && !e.target.closest('.expand-btn') && !e.target.closest('.color-change-btn')) {
                            this.loadNote(note.id);
                            // Apri automaticamente la sub-sidebar se la nota ha sotto-note
                            if (hasSubNotes) {
                                this.openSubSidebar(note.id);
                            } else {
                                this.closeSubSidebar();
                            }
                        }
                    });
                    
                    notesList.appendChild(noteItem);
                });
            }
            
            getTextPreview(html) {
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const text = temp.textContent || temp.innerText || '';
                return text.length > 50 ? text.substring(0, 50) + '...' : text;
            }
            
            updateWordCount() {
                const editor = document.getElementById('editor');
                const text = editor.textContent || editor.innerText || '';
                const words = text.trim() ? text.trim().split(/\s+/).length : 0;
                document.getElementById('word-count').textContent = `Parole: ${words}`;
            }
            
            updateLastSaved(timestamp) {
                const date = new Date(timestamp);
                const formatted = date.toLocaleString('it-IT');
                document.getElementById('last-saved').textContent = `Ultima modifica: ${formatted}`;
            }
            
            toggleColorPicker() {
                const colorPicker = document.getElementById('color-picker-container');
                if (colorPicker.style.display === 'none' || !colorPicker.style.display) {
                    colorPicker.style.display = 'block';
                } else {
                    this.hideColorPicker();
                }
            }
            
            hideColorPicker() {
                document.getElementById('color-picker-container').style.display = 'none';
            }
            
            selectColor(color) {
                this.selectedColor = color;
                
                // Aggiorna visivamente il colore selezionato
                document.querySelectorAll('.color-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            }
            
            changeNoteColor(noteId) {
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;
                
                // Mostra il selettore colori
                this.showColorChangePicker(noteId);
            }
            
            showColorChangePicker(noteId) {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
                const colorHtml = colors.map(color => 
                    `<button onclick="app.applyColorToNote('${noteId}', '${color}')" 
                     style="background-color: ${color}; width: 25px; height: 25px; margin: 2px; border: none; border-radius: 50%; cursor: pointer;"></button>`
                ).join('');
                
                if (confirm('Vuoi cambiare il colore di questa nota?\n\nClicca OK e poi scegli un colore.')) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                             background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Scegli un colore:</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                ${colorHtml}
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                Annulla
                            </button>
                        </div>
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" 
                             onclick="this.parentElement.remove()"></div>
                    `;
                    document.body.appendChild(tempDiv);
                }
            }
            
            applyColorToNote(noteId, color) {
                const note = this.notes.find(n => n.id === noteId);
                if (note) {
                    note.color = color;
                    note.updatedAt = new Date().toISOString();
                    this.saveNotes();
                    this.renderNotesList();
                    
                    // Rimuovi il picker temporaneo
                    const picker = document.querySelector('div[style*="position: fixed"]')?.parentElement;
                    if (picker) picker.remove();
                }
            }
            
            toggleSubColorPicker() {
                const colorPicker = document.getElementById('sub-color-picker-container');
                if (colorPicker.style.display === 'none' || !colorPicker.style.display) {
                    colorPicker.style.display = 'block';
                } else {
                    this.hideSubColorPicker();
                }
            }
            
            hideSubColorPicker() {
                document.getElementById('sub-color-picker-container').style.display = 'none';
            }
            
            selectSubColor(color) {
                this.selectedSubColor = color;
                
                // Aggiorna visualmente il colore selezionato
                document.querySelectorAll('.sub-color-btn').forEach(btn => {
                    btn.classList.remove('selected');
                });
                
                document.querySelector(`[data-color="${color}"]`).classList.add('selected');
            }
            
            changeSubNoteColor(subNoteId) {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote || !parentNote.subNotes) return;
                
                const subNote = parentNote.subNotes.find(n => n.id === subNoteId);
                if (!subNote) return;
                
                // Mostra il selettore colori per sotto-note
                this.showSubColorChangePicker(subNoteId);
            }
            
            showSubColorChangePicker(subNoteId) {
                const colors = ['#3498db', '#e74c3c', '#2ecc71', '#f39c12', '#9b59b6', '#1abc9c', '#e67e22', '#34495e'];
                const colorHtml = colors.map(color => 
                    `<button onclick="app.applyColorToSubNote('${subNoteId}', '${color}')" 
                     style="background-color: ${color}; width: 25px; height: 25px; margin: 2px; border: none; border-radius: 50%; cursor: pointer;"></button>`
                ).join('');
                
                if (confirm('Vuoi cambiare il colore di questa sotto-nota?\n\nClicca OK e poi scegli un colore.')) {
                    const tempDiv = document.createElement('div');
                    tempDiv.innerHTML = `
                        <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                             background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 1000;">
                            <h3 style="color: #2c3e50; margin-bottom: 15px;">Scegli un colore per la sotto-nota:</h3>
                            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 15px;">
                                ${colorHtml}
                            </div>
                            <button onclick="this.parentElement.parentElement.remove()" 
                                    style="background: #95a5a6; color: white; border: none; padding: 8px 16px; border-radius: 5px; cursor: pointer;">
                                Annulla
                            </button>
                        </div>
                        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999;" 
                             onclick="this.parentElement.remove()"></div>
                    `;
                    document.body.appendChild(tempDiv);
                }
            }
            
            applyColorToSubNote(subNoteId, color) {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote || !parentNote.subNotes) return;
                
                const subNote = parentNote.subNotes.find(n => n.id === subNoteId);
                if (subNote) {
                    subNote.color = color;
                    subNote.updatedAt = new Date().toISOString();
                    this.saveNotes();
                    this.renderSubNotesList();
                    
                    // Rimuovi il picker temporaneo
                    const picker = document.querySelector('div[style*="position: fixed"]')?.parentElement;
                    if (picker) picker.remove();
                }
            }
            
            exportBackup() {
                try {
                    const backupData = {
                        version: "1.0",
                        exportDate: new Date().toISOString(),
                        notes: this.notes,
                        appName: "MyNotes"
                    };
                    
                    const dataStr = JSON.stringify(backupData, null, 2);
                    const dataBlob = new Blob([dataStr], { type: 'application/json' });
                    
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = `mynotes-backup-${new Date().toISOString().split('T')[0]}.json`;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('Backup esportato con successo!');
                } catch (error) {
                    console.error('Errore durante l\'esportazione:', error);
                    alert('Errore durante l\'esportazione del backup.');
                }
            }
            
            importBackup(file) {
                if (!file) return;
                
                if (!file.name.endsWith('.json')) {
                    alert('Per favore seleziona un file JSON valido.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        // Verifica la struttura del backup
                        if (!backupData.notes || !Array.isArray(backupData.notes)) {
                            throw new Error('Formato backup non valido');
                        }
                        
                        // Conferma importazione
                        const confirmMessage = `Vuoi importare questo backup?\n\n` +
                            `Data esportazione: ${backupData.exportDate ? new Date(backupData.exportDate).toLocaleString('it-IT') : 'Sconosciuta'}\n` +
                            `Numero di note: ${backupData.notes.length}\n\n` +
                            `ATTENZIONE: Questo sostituirà tutte le note esistenti!`;
                        
                        if (!confirm(confirmMessage)) {
                            return;
                        }
                        
                        // Importa le note
                        this.notes = backupData.notes;
                        this.saveNotes();
                        this.renderNotesList();
                        this.closeSubSidebar();
                        
                        // Carica la prima nota se disponibile
                        if (this.notes.length > 0) {
                            this.loadNote(this.notes[0].id);
                        } else {
                            this.createNewNote();
                        }
                        
                        alert(`Backup importato con successo! ${this.notes.length} note ripristinate.`);
                        
                    } catch (error) {
                        console.error('Errore durante l\'importazione:', error);
                        alert('Errore durante l\'importazione del backup. Verifica che il file sia valido.');
                    }
                };
                
                reader.readAsText(file);
                
                // Reset dell'input file
                document.getElementById('backup-file-input').value = '';
            }
            
            openSubSidebar(noteId) {
                this.currentParentNoteId = noteId;
                const note = this.notes.find(n => n.id === noteId);
                if (!note) return;
                
                // Initialize subNotes array if it doesn't exist
                if (!note.subNotes) {
                    note.subNotes = [];
                    this.saveNotes();
                }
                
                document.getElementById('parent-note-title').textContent = `Sotto-note di: ${note.title}`;
                document.getElementById('sub-sidebar').classList.add('open');
                this.isSubSidebarOpen = true;
                this.renderSubNotesList();
            }
            
            closeSubSidebar() {
                document.getElementById('sub-sidebar').classList.remove('open');
                this.isSubSidebarOpen = false;
                this.currentParentNoteId = null;
            }
            
            createNewSubNote() {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote) return;
                
                const newSubNote = {
                    id: Date.now().toString(),
                    title: 'Nuova Sotto-nota',
                    content: '<p>Inizia a scrivere qui...</p>',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    color: this.selectedSubColor
                };
                
                if (!parentNote.subNotes) {
                    parentNote.subNotes = [];
                }
                
                parentNote.subNotes.unshift(newSubNote);
                this.saveNotes();
                this.renderSubNotesList();
                this.renderNotesList(); // Update main sidebar to show expand icon
                this.loadSubNote(newSubNote.id);
            }
            
            loadSubNote(subNoteId) {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote || !parentNote.subNotes) return;
                
                const subNote = parentNote.subNotes.find(n => n.id === subNoteId);
                if (!subNote) return;
                
                this.currentNoteId = subNoteId;
                
                document.getElementById('note-title').value = subNote.title;
                document.getElementById('editor').innerHTML = subNote.content;
                
                // Update active sub-note in sidebar
                document.querySelectorAll('.sub-note-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const subNoteItem = document.querySelector(`[data-sub-note-id="${subNoteId}"]`);
                if (subNoteItem) {
                    subNoteItem.classList.add('active');
                }
                
                this.updateLastSaved(subNote.updatedAt);
            }
            
            deleteSubNote(subNoteId) {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote || !parentNote.subNotes) return;
                
                if (confirm('Sei sicuro di voler eliminare questa sotto-nota?')) {
                    parentNote.subNotes = parentNote.subNotes.filter(n => n.id !== subNoteId);
                    this.saveNotes();
                    this.renderSubNotesList();
                    this.renderNotesList(); // Update main sidebar
                    
                    if (this.currentNoteId === subNoteId) {
                        if (parentNote.subNotes.length > 0) {
                            this.loadSubNote(parentNote.subNotes[0].id);
                        } else {
                            this.loadNote(this.currentParentNoteId);
                        }
                    }
                }
            }
            
            renderSubNotesList() {
                if (!this.currentParentNoteId) return;
                
                const parentNote = this.notes.find(n => n.id === this.currentParentNoteId);
                if (!parentNote) return;
                
                const subNotesList = document.getElementById('sub-notes-list');
                subNotesList.innerHTML = '';
                
                const subNotes = parentNote.subNotes || [];
                
                subNotes.forEach(subNote => {
                    const subNoteItem = document.createElement('div');
                    subNoteItem.className = 'sub-note-item';
                    subNoteItem.setAttribute('data-sub-note-id', subNote.id);
                    
                    const preview = this.getTextPreview(subNote.content);
                    const date = new Date(subNote.updatedAt).toLocaleDateString('it-IT');
                    
                    // Applica il colore della sotto-nota se presente
                    if (subNote.color) {
                        subNoteItem.style.borderLeftColor = subNote.color;
                        subNoteItem.classList.add('has-color');
                    }
                    
                    subNoteItem.innerHTML = `
                        <h5>${subNote.title}</h5>
                        <p>${preview} • ${date}</p>
                        <button class="delete-btn" onclick="app.deleteSubNote('${subNote.id}')" title="Elimina sotto-nota">
                            <i class="fas fa-trash"></i>
                        </button>
                        <button class="sub-color-change-btn" onclick="app.changeSubNoteColor('${subNote.id}')" title="Cambia colore">
                            <i class="fas fa-palette"></i>
                        </button>
                    `;
                    
                    subNoteItem.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('delete-btn') && 
                            !e.target.classList.contains('sub-color-change-btn') && 
                            !e.target.classList.contains('fas')) {
                            this.loadSubNote(subNote.id);
                        }
                    });
                    
                    subNotesList.appendChild(subNoteItem);
                });
            }
        }

        // Text formatting functions
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            document.getElementById('editor').focus();
            
            // Update toolbar button states
            updateToolbarStates();
        }

        function insertTable() {
            const rows = prompt('Numero di righe:', '3');
            const cols = prompt('Numero di colonne:', '3');
            
            if (rows && cols) {
                let tableHTML = '<table>';
                
                // Header row
                tableHTML += '<tr>';
                for (let j = 0; j < parseInt(cols); j++) {
                    tableHTML += '<th>Intestazione ' + (j + 1) + '</th>';
                }
                tableHTML += '</tr>';
                
                // Data rows
                for (let i = 1; i < parseInt(rows); i++) {
                    tableHTML += '<tr>';
                    for (let j = 0; j < parseInt(cols); j++) {
                        tableHTML += '<td>Cella ' + i + ',' + (j + 1) + '</td>';
                    }
                    tableHTML += '</tr>';
                }
                
                tableHTML += '</table><p></p>';
                
                document.execCommand('insertHTML', false, tableHTML);
            }
        }

        function updateToolbarStates() {
            const commands = ['bold', 'italic', 'underline'];
            
            commands.forEach(command => {
                const button = document.querySelector(`button[onclick="formatText('${command}')"]`);
                if (button) {
                    if (document.queryCommandState(command)) {
                        button.classList.add('active');
                    } else {
                        button.classList.remove('active');
                    }
                }
            });
        }

        // Initialize the app
        let app;
        document.addEventListener('DOMContentLoaded', () => {
            try {
                console.log('Inizializzazione app...');
                
                // Verifica caricamento CSS
                const appContainer = document.querySelector('.app-container');
                const computedStyle = window.getComputedStyle(appContainer);
                console.log('CSS caricato:', computedStyle.display === 'flex' ? 'SI' : 'NO');
                console.log('Display attuale:', computedStyle.display);
                
                // Forza il layout se necessario
                if (computedStyle.display !== 'flex') {
                    console.log('Forzando layout CSS...');
                    appContainer.style.display = 'flex';
                    appContainer.style.height = '100vh';
                }
                
                app = new NotesApp();
                console.log('App inizializzata con successo');
                console.log('Pulsanti collegati:', document.getElementById('add-note-btn') ? 'SI' : 'NO');
            } catch (error) {
                console.error('Errore durante l\'inizializzazione:', error);
                alert('Errore durante l\'avvio dell\'app: ' + error.message);
            }
        });

        // Update toolbar states on selection change
        document.addEventListener('selectionchange', updateToolbarStates);
    </script>
</body>
</html>
